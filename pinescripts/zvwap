// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© timboakimbo

//@version=3
study("Z distance from VWAP", shorttitle="ZVWAP")

cumulativePeriod = input(168, title="Period")

typicalPrice = (high + low + close) / 3
typicalPriceVolume = typicalPrice * volume
v2 = typicalPrice * typicalPrice * volume
cumulativeTypicalPriceVolume = sum(typicalPriceVolume, cumulativePeriod)
cumulativeVolume = sum(volume, cumulativePeriod)
v2sum = sum(v2, cumulativePeriod)
vwapPeriod = cumulativeTypicalPriceVolume / cumulativeVolume
dev = 0.0
dev := sqrt(max(v2sum/cumulativeVolume - vwapPeriod*vwapPeriod, 0))
    
upperTop=input(3)
upperBottom=input(2.0)
lowerTop=input(-3)
lowerBottom=input(-2.0)

ul1=plot(upperTop, "OB High")
ul2=plot(upperBottom, "OB Low")
fill(ul1,ul2, color=red)
ll1=plot(lowerTop, "OS High")
ll2=plot(lowerBottom, "OS Low")
plot(0, color=silver, linewidth=1)
fill(ll1,ll2, color=green)

plot((vwapPeriod-close)/dev,title="ZVWAP",color=white, linewidth=2, transp=0)

